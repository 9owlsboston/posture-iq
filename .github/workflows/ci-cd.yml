# PostureIQ — CI/CD Pipeline
#
# GitHub Actions workflow: lint → test → bicep-validate → build → deploy
# Triggers on push to main and PRs.
# Coverage threshold: 80% (fail build if below)
#
# Authentication: OIDC Workload Identity Federation (zero stored secrets)
#
# Required GitHub Secrets (non-sensitive IDs only):
#   AZURE_CLIENT_ID        — App Registration client ID with federated credential
#   AZURE_TENANT_ID        — Entra ID tenant ID
#   AZURE_SUBSCRIPTION_ID  — Azure subscription ID

name: PostureIQ CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  id-token: write  # Required for OIDC token request

env:
  PYTHON_VERSION: "3.11"
  CONTAINER_IMAGE_NAME: "postureiq"
  RESOURCE_GROUP: "rg-postureiq-dev"

jobs:
  # ── Lint & Type Check ──────────────────────────────────
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Ruff lint
        run: ruff check src/ tests/

      - name: Ruff format check
        run: ruff format --check src/ tests/

      - name: MyPy type check
        run: mypy src/
        continue-on-error: true  # Don't block on type errors during early dev

  # ── Test ───────────────────────────────────────────────
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-report=html:htmlcov \
            --cov-fail-under=80 \
            --junitxml=test-results.xml

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xml

  # ── Validate Bicep IaC ─────────────────────────────────
  bicep-validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Bicep CLI
        run: az bicep install

      - name: Bicep lint — main template
        run: az bicep lint --file infra/main.bicep

      - name: Bicep build — verify compilation
        run: az bicep build --file infra/main.bicep --stdout > /dev/null

      - name: Validate parameter files
        run: |
          echo "Validating dev parameters..."
          az bicep build-params --file infra/parameters/dev.bicepparam --stdout > /dev/null
          echo "Validating prod parameters..."
          az bicep build-params --file infra/parameters/prod.bicepparam --stdout > /dev/null

  # ── Build Container Image ──────────────────────────────
  build:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: [test, bicep-validate]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image_tag: ${{ steps.meta.outputs.GIT_SHA }}
      acr_login_server: ${{ steps.acr.outputs.LOGIN_SERVER }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get ACR login server from resource group
        id: acr
        run: |
          LOGIN_SERVER=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[0].loginServer" -o tsv)
          echo "LOGIN_SERVER=$LOGIN_SERVER" >> $GITHUB_OUTPUT
          echo "ACR login server: $LOGIN_SERVER"

      - name: Login to ACR (OIDC — no admin credentials)
        run: az acr login --name $(echo "${{ steps.acr.outputs.LOGIN_SERVER }}" | cut -d. -f1)

      - name: Set build metadata
        id: meta
        run: |
          echo "GIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build \
            --build-arg GIT_SHA=${{ steps.meta.outputs.GIT_SHA }} \
            --build-arg BUILD_TIME=${{ steps.meta.outputs.BUILD_TIME }} \
            -t ${{ steps.acr.outputs.LOGIN_SERVER }}/${{ env.CONTAINER_IMAGE_NAME }}:${{ steps.meta.outputs.GIT_SHA }} \
            -t ${{ steps.acr.outputs.LOGIN_SERVER }}/${{ env.CONTAINER_IMAGE_NAME }}:latest \
            .

      - name: Push to ACR
        run: |
          docker push ${{ steps.acr.outputs.LOGIN_SERVER }}/${{ env.CONTAINER_IMAGE_NAME }}:${{ steps.meta.outputs.GIT_SHA }}
          docker push ${{ steps.acr.outputs.LOGIN_SERVER }}/${{ env.CONTAINER_IMAGE_NAME }}:latest

  # ── Deploy to Azure Container Apps ─────────────────────
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.RESOURCE_GROUP }}
          template: ./infra/main.bicep
          parameters: >-
            ./infra/parameters/dev.bicepparam
            containerImage=${{ needs.build.outputs.acr_login_server }}/${{ env.CONTAINER_IMAGE_NAME }}:${{ needs.build.outputs.image_tag }}
          failOnStdErr: false
