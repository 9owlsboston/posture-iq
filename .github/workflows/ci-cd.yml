# PostureIQ — CI/CD Pipeline
#
# GitHub Actions workflow: lint → test → bicep-validate → build → deploy
# Triggers on push to main and PRs.
# Coverage threshold: 80% (fail build if below)

name: PostureIQ CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

env:
  PYTHON_VERSION: "3.11"
  AZURE_CONTAINER_REGISTRY: "" # e.g., postureiqacr.azurecr.io
  CONTAINER_IMAGE_NAME: "postureiq"
  RESOURCE_GROUP: "rg-postureiq-dev"

jobs:
  # ── Lint & Type Check ──────────────────────────────────
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Ruff lint
        run: ruff check src/ tests/

      - name: Ruff format check
        run: ruff format --check src/ tests/

      - name: MyPy type check
        run: mypy src/
        continue-on-error: true  # Don't block on type errors during early dev

  # ── Test ───────────────────────────────────────────────
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest \
            --cov=src \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-report=html:htmlcov \
            --cov-fail-under=80 \
            --junitxml=test-results.xml

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xml

  # ── Validate Bicep IaC ─────────────────────────────────
  bicep-validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Bicep CLI
        run: az bicep install

      - name: Bicep lint — main template
        run: az bicep lint --file infra/main.bicep

      - name: Bicep build — verify compilation
        run: az bicep build --file infra/main.bicep --stdout > /dev/null

      - name: Validate parameter files
        run: |
          echo "Validating dev parameters..."
          az bicep build-params --file infra/parameters/dev.bicepparam --stdout > /dev/null
          echo "Validating prod parameters..."
          az bicep build-params --file infra/parameters/prod.bicepparam --stdout > /dev/null

  # ── Build Container Image ──────────────────────────────
  build:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: [test, bicep-validate]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set build metadata
        id: meta
        run: |
          echo "GIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build \
            --build-arg GIT_SHA=${{ steps.meta.outputs.GIT_SHA }} \
            --build-arg BUILD_TIME=${{ steps.meta.outputs.BUILD_TIME }} \
            -t ${{ env.CONTAINER_IMAGE_NAME }}:${{ steps.meta.outputs.GIT_SHA }} \
            -t ${{ env.CONTAINER_IMAGE_NAME }}:latest \
            .

      # TODO: Uncomment when ACR is provisioned
      # - name: Login to Azure Container Registry
      #   uses: azure/docker-login@v1
      #   with:
      #     login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}
      #     username: ${{ secrets.ACR_USERNAME }}
      #     password: ${{ secrets.ACR_PASSWORD }}
      #
      # - name: Push to ACR
      #   run: |
      #     docker tag ${{ env.CONTAINER_IMAGE_NAME }}:latest ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.CONTAINER_IMAGE_NAME }}:latest
      #     docker tag ${{ env.CONTAINER_IMAGE_NAME }}:${{ steps.meta.outputs.GIT_SHA }} ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.CONTAINER_IMAGE_NAME }}:${{ steps.meta.outputs.GIT_SHA }}
      #     docker push ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.CONTAINER_IMAGE_NAME }}:latest
      #     docker push ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.CONTAINER_IMAGE_NAME }}:${{ steps.meta.outputs.GIT_SHA }}

  # ── Deploy to Azure Container Apps ─────────────────────
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.RESOURCE_GROUP }}
          template: ./infra/main.bicep
          parameters: ./infra/parameters/dev.bicepparam
          failOnStdErr: false
